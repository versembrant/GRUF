{% extends "base.html" %}

{% block content %}
<h1>Sessi√≥ "{{ session.name }}"{% if local_mode %} (local){% endif %}</h1>
<a href="/">Torna a la llista de sessions</a>
<div id="root"></div>
{% endblock %}

{% block extra_body %}
<script type="text/javascript">
    const sessionUUID = "{{ session.uuid }}"; // sessionUUID is used in sessionManager.js
    var currentSession = undefined;
    var local = false;
    {% if local_mode %}
        // In local mode, session data is passed directly and server is not involved once the session is newSessionDataLoaded
        const sessionData = JSON.parse('{{ session.get_full_data() | tojson | safe }}');
        local = true;
        currentSession = new Session(sessionData, local); 
        setTimeout(() => {
            // Use a timeout to make sure all JS stuff has been loaded before the event is fired
            document.dispatchEvent(new Event("newSessionDataLoaded"));
        }, 500)
    {% else %}
        // In remote mode, all session updates go through the server and come from the server
        socket.on('connect', function() {
            const username = (Math.random() + 1).toString(36).substring(7);
            socket.emit('join_session', {session_uuid: sessionUUID, username: username})
        });
        socket.on('set_session_data', function (data) {
            currentSession = new Session(data, local); 
            document.dispatchEvent(new Event("newSessionDataLoaded"));
        });
        socket.on('update_session_parameter', function (data) {
            if ((currentSession !== undefined) && (data.session_uuid === currentSession.uuid)) {
                currentSession.updateParametreEstacio(data.nom_estacio, data.nom_parametre, data.valor);
            }
        });
    {% endif %}
</script>

{% endblock %}